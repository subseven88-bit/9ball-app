<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<meta name="apple-mobile-web-app-title" content="Ultimate++">

<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/google/material-design-icons/master/png/hardware/toys/materialicons/24dp/2x/baseline_toys_black_24dp.png">
<link rel="icon" type="image/png" href="https://img.icons8.com/color/180/billiards.png">
<link rel="apple-touch-icon" href="https://img.icons8.com/color/180/billiards.png">

<title>9-Ball Ultimate++</title>
<style>
:root{--bg1:#0f8a44;--bg2:#063d1c;--card:#0f7a3a;--header:#052b14;--accent:#ffe066;--text:#fff;--danger:#e53935;--info:#2196f3;}
body.dark{--bg1:#1a1a1a;--bg2:#000;--card:#2c2c2c;--header:#111;--text:#eee;--danger:#b71c1c;--info:#1565c0;}
body{
  font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background:radial-gradient(circle at top,var(--bg1),var(--bg2));
  color:var(--text);
  margin:0;
  touch-action:manipulation;
  -webkit-tap-highlight-color:transparent;
  min-height:100vh;
  overflow-x:hidden;
}

header{background:var(--header);padding:1rem;padding-top:max(1rem, env(safe-area-inset-top));text-align:center;font-weight:800;letter-spacing:1px;box-shadow:0 2px 5px rgba(0,0,0,0.3);position:relative;z-index:10;display:flex;justify-content:center;align-items:center;}
header h1 {margin:0; font-size:1.2rem;}
.header-btn {position:absolute; right:1rem; background:transparent; border:none; color:var(--text); font-size:1.5rem; padding:0; width:auto; margin:0;}

.container{
  padding:1rem;
  max-width:500px;
  margin:auto;
  padding-bottom:120px;
  padding-left:max(1rem, env(safe-area-inset-left));
  padding-right:max(1rem, env(safe-area-inset-right));
} 

.card{background:var(--card);border-radius:16px;padding:1.2rem;margin-bottom:1rem;box-shadow:0 4px 6px rgba(0,0,0,0.2);}
h3{margin-top:0;}

/* Buttons */
button{
  background:#1ec773; border:none; border-radius:12px; padding:1rem;
  font-size:1rem; font-weight:bold; color:#000; cursor:pointer; width:100%;
  margin-bottom:0.5rem; -webkit-appearance: none;
}
button:active{ opacity: 0.6; }
button:disabled{ opacity: 0.3; cursor: default; }
button.secondary{background:rgba(0,0,0,0.3);color:var(--text);}
button.danger{background:var(--danger);color:#fff;}
button.info{background:var(--info); color:#fff;}

.btn-row{display:flex;gap:0.5rem;}
.btn-row button{margin-bottom:0;}

/* Inputs */
input{width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:none; font-size:1rem; box-sizing:border-box; background: rgba(255,255,255,0.9);}

/* Ball Grid */
.ball-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:1rem 0;}
.ball{border-radius:50%;aspect-ratio:1;height:auto;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1.4rem;box-shadow:inset -3px -3px 5px rgba(0,0,0,0.3);border:2px solid transparent;cursor:pointer;padding:0;width:100%;-webkit-user-select:none;user-select:none;}
.ball.sel{border:3px solid #fff;box-shadow:0 0 15px var(--accent);}
.ball.ghost{opacity:0.2;pointer-events:none;filter:grayscale(1);}

/* Table */
table{width:100%;border-collapse:collapse;margin-top:0.5rem;}
th,td{padding:.8rem;text-align:left;border-bottom:1px solid rgba(255,255,255,.1);}
td:last-child{text-align:right;font-weight:bold;font-size:1.2rem;}
.active-row{background:rgba(255,255,255,0.1);color:var(--accent);}

/* Info & Modals */
.info-box{background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;text-align:center;margin-bottom:1rem;}
.info-label{font-size:0.8rem;opacity:0.8;text-transform:uppercase;}
.info-val{font-size:1.4rem;font-weight:bold;color:var(--accent);}
.link-danger{color:#ff9999;font-size:0.8rem;text-decoration:underline;cursor:pointer;display:inline-block;margin-top:5px;padding:10px;}

#modalOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(5px);padding:1rem;}
.modal-box{background:var(--card);padding:2rem;border-radius:20px;max-width:350px;width:100%;text-align:center;border:1px solid rgba(255,255,255,0.1);box-shadow: 0 10px 25px rgba(0,0,0,0.5);max-height:80vh;overflow-y:auto;}
.rules-content {text-align:left; font-size:0.95rem; line-height:1.5; margin-bottom:1.5rem;}
.rules-content li {margin-bottom:0.5rem;}

/* CSS RACK VISUALIZATION (Der Aufbau) */
.rack-visual { display: flex; flex-direction: column; align-items: center; gap: 4px; margin-bottom: 15px; margin-top:10px;}
.rack-row { display: flex; gap: 4px; }
.b-mini { width: 24px; height: 24px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: #333; box-shadow: inset -2px -2px 5px rgba(0,0,0,0.3); border:1px solid rgba(0,0,0,0.2); }
.b-1 { background: #f7d51d; color: #000; }
.b-9 { background: #ffeb3b; border: 2px solid #fff; color: #000; box-shadow: 0 0 0 1px #000 inset; }

/* Confetti */
.confetti {position: fixed; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; pointer-events: none;}
@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
</style>
</head>
<body>
<header>
  <h1>üé± Ultimate++</h1>
  <button class="header-btn" id="headerRulesBtn" type="button">üìñ</button>
</header>

<div class="container">

  <div class="card" id="setup">
    <h3>Spieler Setup</h3>
    <div id="playerInputs">
      <input placeholder="Spieler 1 Name" value="Spieler 1">
      <input placeholder="Spieler 2 Name" value="Spieler 2">
    </div>
    <div class="btn-row" style="margin-bottom:1rem;">
      <button class="secondary" id="addPlayerBtn" type="button">+ Spieler</button>
      <button class="secondary" id="removePlayerBtn" type="button">-</button>
    </div>
    <button id="startBtn" type="button">Abend starten</button>
    <button class="secondary" id="setupRulesBtn" type="button" style="margin-top:0.5rem;">üìñ Spielregeln anzeigen</button>
    
    <div id="restoreArea" style="display:none; text-align:center; border-top:1px solid rgba(255,255,255,0.2); padding-top:1rem; margin-top:1rem;">
      <p>Laufendes Spiel gefunden!</p>
      <button class="secondary" id="restoreBtn">Fortsetzen</button>
    </div>
  </div>

  <div class="card" id="game" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <span id="roundCounter" style="opacity:0.7;font-size:0.9rem;">Runde 1</span>
      <button id="themeToggle" style="width:auto;padding:8px 12px;font-size:0.9rem;background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.3);margin:0;">üåó</button>
    </div>
    
    <div class="info-box">
      <div class="info-label">Am Sto√ü</div>
      <div class="info-val" id="currentPlayerName"></div>
      <div style="font-size:0.9rem;margin-top:5px;">Niedrigste Kugel: <b id="lowestDisplay" style="color:var(--accent)">1</b></div>
    </div>

    <p style="text-align:center;margin-bottom:5px;">Welche Kugeln wurden gelocht?</p>
    <div class="ball-grid" id="ballGrid"></div>

    <button id="confirmShot" type="button">Sto√ü best√§tigen</button>
    
    <div class="btn-row">
      <button class="secondary" id="noPocketBtn" type="button">Kein Loch / Weiter</button>
      <button class="danger" id="foulBtn" type="button">Foul (-2)</button>
    </div>
    <div style="margin-top:0.5rem; text-align:right;">
       <button class="secondary" id="undoBtn" type="button" style="width:auto; font-size:0.8rem; padding: 0.5rem 1rem;">‚Ü© Undo</button>
    </div>
  </div>

  <div class="card" id="scores" style="display:none;">
    <h3>Punktestand</h3>
    <table id="scoreTable"></table>
  </div>

  <div class="card" id="stats" style="display:none;">
    <h3>Statistik</h3>
    <p id="statsText" style="font-size:0.9rem;"></p>
    <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;max-height:150px;overflow-y:auto;margin-bottom:1rem;">
      <ul id="roundList" style="margin:0;padding-left:1.2rem;font-size:0.9rem;"></ul>
    </div>
    
    <button class="info" id="exportBtn" type="button" style="margin-bottom:1rem;">üìã Statistik kopieren</button>

    <div style="border-top:1px solid rgba(255,255,255,0.2);padding-top:1rem;">
      <h4 style="margin:0;">üèÜ Tischrekord</h4>
      <p id="recordText" style="margin:0.5rem 0;color:var(--accent);font-weight:bold;font-size:1.1rem;"></p>
      <div style="text-align:right;">
         <span id="resetRecordBtn" class="link-danger">Rekord l√∂schen</span>
      </div>
    </div>
    <br>
    <button class="danger" id="newEveningBtn" type="button">üåô Abend beenden / Reset</button>
  </div>

</div>

<div id="modalOverlay">
  <div class="modal-box">
    <h2 id="mTitle" style="color:var(--accent);margin-top:0;"></h2>
    <div id="mContent"></div>
    <p id="mText" style="font-size:1.1rem;line-height:1.5;margin:1.5rem 0;"></p>
    
    <button id="mOkBtn" type="button" style="margin-top:1rem;display:none;">OK</button>
    
    <div id="mConfirmBtns" class="btn-row" style="display:none;margin-top:1rem;">
        <button class="secondary" id="mCancelBtn">Abbrechen</button>
        <button class="danger" id="mYesBtn">Ja</button>
    </div>
  </div>
</div>

<script>
// --- CONFIGURATION ---
const ballColors = [
  {bg:'#f7d51d', txt:'#000'}, // 1
  {bg:'#1e90ff', txt:'#fff'}, // 2
  {bg:'#e53935', txt:'#fff'}, // 3
  {bg:'#6a1b9a', txt:'#fff'}, // 4
  {bg:'#ff9800', txt:'#000'}, // 5
  {bg:'#2e7d32', txt:'#fff'}, // 6
  {bg:'#8d6e63', txt:'#fff'}, // 7
  {bg:'#111111', txt:'#fff'}, // 8
  {bg:'#ffeb3b', txt:'#000'}  // 9
];

// REGELN (HTML String mit CSS-Raute)
const RULES_HTML = `
  <div class="rules-content">
    <div style="text-align:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:1rem;">
      <div class="rack-visual">
        <div class="rack-row"><div class="b-mini b-1">1</div></div>
        <div class="rack-row"><div class="b-mini"></div><div class="b-mini"></div></div>
        <div class="rack-row"><div class="b-mini"></div><div class="b-mini b-9">9</div><div class="b-mini"></div></div>
        <div class="rack-row"><div class="b-mini"></div><div class="b-mini"></div></div>
        <div class="rack-row"><div class="b-mini"></div></div>
      </div>
      <p style="font-size:0.8rem;opacity:0.7;margin:0;">Die 1 auf den Fu√üpunkt (Spitze),<br>die 9 in die Mitte (Raute).</p>
    </div>
    <ul>
      <li><b>Ziel:</b> Erreiche die meisten Punkte.</li>
      <li><b>Grundregel:</b> Es wird immer auf die niedrigste Kugel am Tisch gespielt.</li>
      <li><b>Punkte:</b>
        <ul>
           <li>Niedrigste Kugel gelocht = <b>Wert der Kugel</b>.</li>
           <li>Kombi = <b>Wert der Kugel + Wert der niedrigsten</b>.</li>
        </ul>
      </li>
      <li><b>Sieg:</b> Wer die 9 locht, gewinnt sofort.</li>
      <li><b>Foul:</b> Wei√üe f√§llt oder niedrigste Kugel nicht getroffen = <b>-2 Punkte</b>. Gegner hat Ball-in-Hand.</li>
    </ul>
  </div>
`;

// --- STATE MANAGEMENT ---
let state = {
  phase: 'setup',
  players: [],
  currentIdx: 0,
  ballsLeft: [],
  pocketed: [],
  history: [],
  undoStack: [],
  roundCount: 1,
  early9Count: 0,
  tableRecord: JSON.parse(localStorage.getItem('uplus_record')) || null
};
let wakeLock = null;
let ui = {};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
  // UI Cache
  ui = {
    setup: document.getElementById('setup'),
    game: document.getElementById('game'),
    scores: document.getElementById('scores'),
    stats: document.getElementById('stats'),
    playerInputs: document.getElementById('playerInputs'),
    grid: document.getElementById('ballGrid'),
    currentName: document.getElementById('currentPlayerName'),
    lowestDisplay: document.getElementById('lowestDisplay'),
    scoreTable: document.getElementById('scoreTable'),
    statsText: document.getElementById('statsText'),
    roundList: document.getElementById('roundList'),
    recordText: document.getElementById('recordText'),
    roundCounter: document.getElementById('roundCounter'),
    // Buttons
    startBtn: document.getElementById('startBtn'),
    restoreBtn: document.getElementById('restoreBtn')
  };

  // Check for saved game
  if(localStorage.getItem('uplus_state')) {
    document.getElementById('restoreArea').style.display = 'block';
  }
  updateRecordUI();

  // Event Listeners (Sauber getrennt)
  document.getElementById('addPlayerBtn').addEventListener('click', addInput);
  document.getElementById('removePlayerBtn').addEventListener('click', removeInput);
  
  ui.startBtn.addEventListener('click', startGame);
  ui.restoreBtn.addEventListener('click', restoreGame);
  
  document.getElementById('confirmShot').addEventListener('click', confirmShot);
  document.getElementById('noPocketBtn').addEventListener('click', nextTurn);
  document.getElementById('foulBtn').addEventListener('click', foul);
  document.getElementById('undoBtn').addEventListener('click', undo);
  
  document.getElementById('newEveningBtn').addEventListener('click', confirmNewEvening);
  document.getElementById('resetRecordBtn').addEventListener('click', confirmResetRecord);
  document.getElementById('themeToggle').addEventListener('click', () => document.body.classList.toggle('dark'));
  
  // Regeln & Export
  document.getElementById('headerRulesBtn').addEventListener('click', showRules);
  document.getElementById('setupRulesBtn').addEventListener('click', showRules);
  document.getElementById('exportBtn').addEventListener('click', exportStats);
});

// --- FUNCTIONS ---

function requestWakeLock() {
  if ('wakeLock' in navigator) {
    try {
      navigator.wakeLock.request('screen').then(l => wakeLock = l);
    } catch (e) { console.log('WakeLock info', e); }
  }
}

function startGame() {
  if(document.activeElement) document.activeElement.blur();
  const inputs = [...ui.playerInputs.querySelectorAll('input')];
  const names = inputs.map(i => i.value.trim() || i.placeholder).filter(n => n);
  
  if(names.length < 1) return showInfo("Fehler", "Bitte mindestens einen Spieler eingeben.");
  
  state.players = names.map(n => ({name: n, score: 0}));
  state.phase = 'playing';
  state.ballsLeft = [1,2,3,4,5,6,7,8,9];
  state.pocketed = [];
  state.currentIdx = 0;
  state.roundCount = 1;
  state.history = [];
  state.undoStack = [];
  
  enterGameMode();
}

function restoreGame() {
  try {
    const saved = JSON.parse(localStorage.getItem('uplus_state'));
    if(saved) {
      state = saved;
      enterGameMode();
    }
  } catch(e) { console.error(e); }
}

function enterGameMode() {
  ui.setup.style.display = 'none';
  ui.game.style.display = 'block';
  ui.scores.style.display = 'block';
  ui.stats.style.display = 'block';
  requestWakeLock();
  
  // Kurzer Delay f√ºr Rendering
  setTimeout(() => {
    ui.game.scrollIntoView({behavior:'smooth'});
    saveState();
    render();
  }, 50);
}

function addInput() {
  const i = document.createElement('input');
  i.placeholder = `Spieler ${ui.playerInputs.children.length + 1}`;
  ui.playerInputs.appendChild(i);
}

function removeInput() {
  if(ui.playerInputs.children.length > 1) ui.playerInputs.lastChild.remove();
}

function getLowest() {
  return Math.min(...state.ballsLeft);
}

function render() {
  const p = state.players[state.currentIdx];
  ui.currentName.textContent = p.name;
  const low = getLowest();
  ui.lowestDisplay.textContent = isFinite(low) ? low : "-";
  ui.roundCounter.textContent = `Runde ${state.roundCount}`;

  // Grid rendern
  ui.grid.innerHTML = '';
  for(let i=1; i<=9; i++) {
    const btn = document.createElement('button');
    btn.className = 'ball';
    const color = ballColors[i-1];
    btn.style.backgroundColor = color.bg;
    btn.style.color = color.txt;
    btn.textContent = i;
    
    if(!state.ballsLeft
